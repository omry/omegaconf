version: 2.1

commands:
  linux:
    description: "Commands run on Linux"
    parameters:
      py_version:
        type: string
    steps:
      - checkout
      - run:
          name: "Preparing environment"
          command: |
            python --version  # check that python is installed
            sudo apt-get update
            sudo apt-get install -y openjdk-11-jre
            pip install nox
      - run:
          name: "Testing OmegaConf"
          command: |
            export NOX_PYTHON_VERSIONS=<< parameters.py_version >>
            # Run only the parametrized sessions (omegaconf, benchmark, test_jupyter_notebook)
            # Skip coverage, lint, docs which are handled by separate jobs
            nox --add-timestamp -s omegaconf benchmark test_jupyter_notebook

jobs:
  test_linux:
    parameters:
      py_version:
        type: string
    docker:
      - image: cimg/python:<< parameters.py_version >>
    steps:
      - linux:
          py_version: << parameters.py_version >>

  coverage:
    docker:
      - image: cimg/python:3.10
    steps:
      - checkout
      - run:
          name: "Preparing environment"
          command: |
            python --version
            sudo apt-get update
            sudo apt-get install -y openjdk-11-jre
            pip install nox
      - run:
          name: "Running coverage"
          command: nox --add-timestamp -s coverage

  lint:
    docker:
      - image: cimg/python:3.10
    steps:
      - checkout
      - run:
          name: "Preparing environment"
          command: |
            python --version
            sudo apt-get update
            sudo apt-get install -y openjdk-11-jre
            pip install nox
      - run:
          name: "Running lint"
          command: nox --add-timestamp -s lint

  docs:
    docker:
      - image: cimg/python:3.10
    steps:
      - checkout
      - run:
          name: "Preparing environment"
          command: |
            python --version
            sudo apt-get update
            sudo apt-get install -y openjdk-11-jre
            pip install nox
      - run:
          name: "Building docs"
          command: nox --add-timestamp -s docs

workflows:
  version: 2
  build:
    jobs:
      - test_linux:
          matrix:
            parameters:
              py_version: ["3.9", "3.10", "3.11", "3.12", "3.13", "3.14"]
      - coverage
      - lint
      - docs
